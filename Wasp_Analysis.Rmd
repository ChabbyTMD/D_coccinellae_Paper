---
title: "D. coccinellae Multivariate Stats"
author: "Scott Monahann and Trevor Mugoya"
date: "`r Sys.Date()`"
output: html_document
---
# libraries
Load important libraries 
```{r}
library(corrplot)
library(factoextra)
library(vegan)
library(tidyverse)
library(Hmisc)
library(readxl)
# Note: before installing MVN package ensure that libgsl is installed with sudo apt-get install libgsl-dev
library(MVN)
library(heplots)
library(devtools)
# install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)
library(packfor)
library(languageR)
```

```{r}
WaspData=read_excel("DATA/morph_data_bk.xlsx")
offspringwasp<-WaspData[,14:19]
parentwasp<-WaspData[,4:9]
```

# PCA
```{r}
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "blue", ...)
}

# pairs(WaspData[,14:19],lower.panel = NULL, diag.panel = panel.hist)
pairs(log(WaspData[,4:9]),lower.panel = NULL, diag.panel = panel.hist)


# Pairwise correlation in our environmental variables
languageR::pairscor.fnc(parentwasp)
# NOTES: The data seem normally distributed for about half of the measured parent morphological characteristics(abdomen length-al, thorax length-tl & wing length-wl). The rest of the morphological measurements seem to have a degree of right skew
WaspPCA <- prcomp(WaspData[,c(4:9,14:18)], center=T, scale. = T)

summary(WaspPCA)

fviz_screeplot(WaspPCA, addlabels = TRUE, ylim = c(0, 50))
fviz_pca_biplot(WaspPCA,
                label="var",
                habillage = WaspData$o.host,
                repel = T)

fviz_pca_biplot(WaspPCA,
                label="var",
                habillage = WaspData$o.host.sl,
                repel = T)

WaspoffspringPCA <- prcomp(WaspData[,c(14:18)], center=T, scale. = T)
fviz_pca_biplot(WaspoffspringPCA,
                label="var",
                habillage = WaspData$o.host,
                repel = T)
summary(WaspoffspringPCA)
```

# RDA
```{r}
# Center and Scale parent and offspring morphmometrics prior to fitting RDA model

offspring.center<-as.data.frame(scale(offspringwasp, center = T, scale = T))
parent.center<-as.data.frame(scale(parentwasp, center = T,scale = T))
parent.center$parent_host<-WaspData$p.host
parent.center$offspring_host<-WaspData$o.host
# Full RDA model
wasp.rda<-rda(offspring.center~p.wl+p.tl+p.td+p.al+p.hd+p.hl+parent_host+offspring_host, data=parent.center)

anova(wasp.rda, by='term', permutations = 9999)
summary(wasp.rda)


R2 <- RsquareAdj(wasp.rda)$r.squared
R2 

# adjusted R^2.
R2adj <- RsquareAdj(wasp.rda)$adj.r.squared
R2adj 

# Constructing ordination plot for our full RDA model. The triplot typically consists of 3 entities; sites, response variables and explanatory variables
plot(wasp.rda)

# For canonical analysis, model significance relies on permutation tests.The principle of a permutation test is to generate a reference distribution of the chosen statistic under the null hypothesis H0
 # by randomly permuting appropriate elements of the data a large number of times and recomputing the statistic each time. Then, one compares the true value of the statistic to this reference distribution. The p value is computed as the proportion of the permuted values equal to or larger than the true (unpermuted) value of the statistic for a one-tailed test in the upper tail, like the F test used in RDA (Borcard, Gillet, and Legendre 2011).

# null hypothesis the observed results can be produced by random chance. we reject the null hypothesis when the p value is less than 0.05

# For an RDA we need to test for the significance of 3 things
# Global RDA significance
#  Performs a permutation test with 999 permutations and assess the F value to determine whether it is significant or not
anova.cca(wasp.rda, permutations = 999) #p~0.07 we fail to reject the null hypothesis, the full RDA model with all parent morphological characteristics and parent and offspring hosts is not significant.
# Axis significance
anova.cca(wasp.rda, by = "axis") # none of the axes seem significant.

# Explanatory variable significance i.e by term.
anova.cca(wasp.rda, by = "terms")

# parent abdomen length seems marginally significant term.

# With multiple linear regression, we have to check that we do not have colinearity among predictors
sqrt(vif.cca(wasp.rda))

# Final ordination plot for full RDA model
ordiplot(wasp.rda, scaling = 2, type = "none", cex = 10, xlab = "RDA1", ylab = "RDA2", cex.lab = 1.25)
points(wasp.rda, col="darkgrey", cex = 1)
points(wasp.rda, dis="sp", col="blue")
text(wasp.rda, dis="sp", col = "blue")
text(wasp.rda, dis="bp", col="black")
```

# Observations

The full RDA model consisting of D. coccinellae offspring wasp morphology, parent wasp morphonology in addition to parent and offspring bettle host species yields only parent abdomen length as a marginally significant term(F=2.9012, p=0.0566).

Subsequently, the adjusted R2 value for the full RDA model is 0.138.

Further evaluating the RDA model we considered global RDA significance, RDA axis significane and explanatory variable significance. Subsequently the global RDA model was not significant and additionallly non of the RDA axes were significant either. Interestingly enough parent throax deoth appears as another marginally significant term.

Evaluating colinearirty among predictors we see that all but one(parent wing length) of the parent morphological measurements are above the threhold of 2 implying they are highly correlated. Parent and offspring host species are not correlated which is not surprising.

The direction of the vectors of the explanatory variables would seem to suggest a positive correlation between parent morphology measurements and offspring measurements. While the direction of offspring host species vectors for C. septempunctata(large bettle offspring host) and H. convergens(small bettle offspring host) are at 180 degrees implying they are negatively correlated. 

# RDA with Principle Components

```{r}

# res <- cor(parentwasp, method="pearson")
res <- cor(WaspData[,c(4:9,14:18)], method="pearson")
res <- cor(offspringwasp, method="pearson")
corrplot::corrplot(res, method= "color", order = "hclust", tl.pos = 'n')

# correlation of PCs
res1 <- cor(WaspPCA$x, method="pearson")
corrplot::corrplot(res1, method= "color", order = "hclust", tl.pos = 'n')

# Percent of variance explanied by PCS
plot(summary(WaspPCA)$importance[3,])

# strength of the loadings of the PCs
fviz_pca_var(WaspPCA,axes = c(1, 2))
fviz_pca_var(WaspPCA,axes = c(3, 4))
fviz_pca_var(WaspPCA,axes = c(5, 6))

# getting PCS into dataframe
pcs <- as.data.frame(WaspPCA$x)

# combining both response and PC explanatory variables.
offspringwasp <- as.data.frame(offspringwasp)
ols.data <- cbind(offspringwasp, pcs)

pc_RDA <- rda(offspring.center~PC1+PC2+PC3+PC4+PC5+PC6+PC7+PC8+PC9+PC10+PC11, data=pcs)
anova(pc_RDA)
summary(pc_RDA)

anova.cca(pc_RDA, permutations = 999) 
anova.cca(pc_RDA, by = "axis") 
anova.cca(pc_RDA, by = "terms")

# checking colinearity of predictors(principle components) in RDA model

sqrt(vif.cca(pc_RDA))

# Collinearity metric between predictors in the stock dataset before scaling and centering is 81 which is a potentially high and harmful degree of collinearity
collin.fnc(dplyr::select(WaspData, p.wl, p.tl, p.td, p.al, p.hd, p.hl))$cnumber
# After centering and scaling predictors, we see that collinearity decreases to an acceptable level of 8.5
collin.fnc(dplyr::select(parent.center, p.wl, p.tl, p.td, p.al, p.hd, p.hl))$cnumber

```